# ğŸš€ Claude Relay Service éƒ¨ç½²ä¸“ç”¨ Docker Compose é…ç½®
# é€‚ç”¨äºå…¶ä»–æœåŠ¡å™¨æ‹‰å–é•œåƒéƒ¨ç½²ï¼Œæ— éœ€æºä»£ç 

version: '3.8'

services:
  # ğŸš€ Claude Relay Service
  claude-relay:
    image: luzhipeng728/claude-relay-service:latest
    container_name: claude-relay-deploy
    restart: unless-stopped
    ports:
      - "9990:3000"
    environment:
      # ğŸŒ æœåŠ¡å™¨é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      
      # ğŸ” å®‰å…¨é…ç½®ï¼ˆé¢„è®¾å€¼ï¼‰
      - JWT_SECRET=claude-relay-deploy-jwt-secret-key-32chars-minimum-length-requirement
      - ENCRYPTION_KEY=claude-relay-deploy-encrypt-key32
      - ADMIN_SESSION_TIMEOUT=86400000
      - API_KEY_PREFIX=cr_
      
      # ğŸ‘¤ ç®¡ç†å‘˜è´¦æˆ·ï¼ˆå›ºå®šå€¼ï¼‰
      - ADMIN_USERNAME=cr_admin_04898b8f
      - ADMIN_PASSWORD=jdJS8SSouq7UVAKo
      
      # ğŸ“Š Redis é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - REDIS_HOST=redis-deploy
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - REDIS_ENABLE_TLS=
      
      # ğŸ¯ Claude API é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - CLAUDE_API_URL=https://api.anthropic.com/v1/messages
      - CLAUDE_API_VERSION=2023-06-01
      - CLAUDE_BETA_HEADER=claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14
      
      # ğŸŒ ä»£ç†é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - DEFAULT_PROXY_TIMEOUT=60000
      - MAX_PROXY_RETRIES=3
      
      # ğŸ“ˆ ä½¿ç”¨é™åˆ¶ï¼ˆå›ºå®šå€¼ï¼‰
      - DEFAULT_TOKEN_LIMIT=1000000
      
      # ğŸ“ æ—¥å¿—é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - LOG_LEVEL=info
      - LOG_MAX_SIZE=10m
      - LOG_MAX_FILES=5
      
      # ğŸ”§ ç³»ç»Ÿé…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - CLEANUP_INTERVAL=3600000
      - TOKEN_USAGE_RETENTION=2592000000
      - HEALTH_CHECK_INTERVAL=60000
      - SYSTEM_TIMEZONE=Asia/Shanghai
      - TIMEZONE_OFFSET=8
      
      # ğŸ¨ Web ç•Œé¢é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - WEB_TITLE=Claude Relay Service
      - WEB_DESCRIPTION=Multi-account Claude API relay service
      - WEB_LOGO_URL=/assets/logo.png
      
      # ğŸš€ æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼ˆåŸºäº8æ ¸CPU+é«˜å†…å­˜ä¼˜åŒ–ï¼‰
      - API_KEY_CACHE_ENABLED=true
      - API_KEY_CACHE_TTL=600
      - API_KEY_CACHE_MAX_SIZE=5000
      - REQUEST_DEDUP_ENABLED=true
      - REQUEST_DEDUP_WINDOW=2000
      - REQUEST_DEDUP_MAX_SIZE=50000
      - COMPRESSION_ENABLED=true
      - COMPRESSION_LEVEL=4
      - COMPRESSION_THRESHOLD=512
      - BATCH_PROCESSING_ENABLED=true
      - BATCH_SIZE=50
      - BATCH_FLUSH_INTERVAL=25
      - REDIS_POOL_MIN=8
      - REDIS_POOL_MAX=80
      
      # ğŸ› ï¸ éƒ¨ç½²é…ç½®ï¼ˆå›ºå®šå€¼ï¼‰
      - DEBUG=false
      - ENABLE_CORS=true
      - TRUST_PROXY=true
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    depends_on:
      redis-deploy:
        condition: service_healthy
    networks:
      - claude-relay-deploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ğŸ“Š Redis Database
  redis-deploy:
    image: redis:7-alpine
    container_name: redis-deploy
    restart: unless-stopped
    ports:
      - "6381:6379"
    volumes:
      - ./redis_data:/data
    command: redis-server --save 60 1 --appendonly yes --appendfsync everysec --maxmemory 4gb --maxmemory-policy allkeys-lru --tcp-keepalive 60 --timeout 300
    networks:
      - claude-relay-deploy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ğŸ“ˆ Redis Commander (Optional - ä»…é™ç®¡ç†)
  redis-commander-deploy:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander-deploy
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=deploy:redis-deploy:6379
      - HTTP_USER=admin
      - HTTP_PASSWORD=admin123
    depends_on:
      redis-deploy:
        condition: service_healthy
    networks:
      - claude-relay-deploy-network
    profiles:
      - tools

# volumes: 
# ä½¿ç”¨å®¿ä¸»æœºç›®å½•ç»‘å®šï¼Œæ— éœ€å®šä¹‰ volumes

networks:
  claude-relay-deploy-network:
    driver: bridge
    name: claude-relay-deploy-network

# ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š
# 
# 1. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ .envï¼š
#    EXTERNAL_PORT=9990
#    JWT_SECRET=ä½ çš„32å­—ç¬¦ä»¥ä¸ŠJWTå¯†é’¥
#    ENCRYPTION_KEY=ä½ çš„32å­—ç¬¦åŠ å¯†å¯†é’¥
#    REDIS_PASSWORD=å¯é€‰çš„Rediså¯†ç 
#
# 2. éƒ¨ç½²å‘½ä»¤ï¼š
#    docker-compose -f docker-compose.deploy.yml up -d
#
# 3. åŒ…å«ç®¡ç†å·¥å…·ï¼š
#    docker-compose -f docker-compose.deploy.yml --profile tools up -d
#
# 4. åœæ­¢æœåŠ¡ï¼š
#    docker-compose -f docker-compose.deploy.yml down
#
# 5. å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰ï¼š
#    docker-compose -f docker-compose.deploy.yml down -v
#
# 6. æŸ¥çœ‹æ—¥å¿—ï¼š
#    docker-compose -f docker-compose.deploy.yml logs -f claude-relay
#
# 7. å¥åº·æ£€æŸ¥ï¼š
#    curl http://localhost:9990/health
#
# 8. Webç®¡ç†ç•Œé¢ï¼š
#    http://localhost:9990/web
#
# 9. Redisç®¡ç†ç•Œé¢ï¼ˆå¦‚æœå¯ç”¨toolsï¼‰ï¼š
#    http://localhost:8081 (ç”¨æˆ·å/å¯†ç è§ç¯å¢ƒå˜é‡è®¾ç½®)